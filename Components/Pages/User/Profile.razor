@page "/profile"
@using MMS.Components.Helpers
@using MMS.Models
@using MMS.Models.ViewModels
@using MMS.Services
@using MMS.Services.Responses
@using Microsoft.AspNetCore.Authorization
@using Radzen
@using System.Security.Claims
@rendermode InteractiveServer
@attribute [Authorize(Roles = "User")]
@attribute [StreamRendering]
@inject UserService UserService
@inject NavigationManager NavigationManager
@inject Notifications Notifications
@inject DialogService DialogService

<PageTitle>MMS - Moj profil</PageTitle>
<h3>Moj profil</h3>

<RadzenRow JustifyContent="JustifyContent.Center">
	@if (user == null || loading)
	{
		<RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
	}
	else
	{
		if (!user.ValidMembership)
		{
			<RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">
				@if (!hasPayments)
				{
					<span>
						Tvoj zahtjev za članstvom je odobren, no još nisi član! Potrebno je uplatiti članarinu. Članarina se plaća za godinu i članstvo
						vrijedi godinu dana od dana plaćanja. 
					</span>
					<RadzenButton Click=@OpenPaymentDialog>Uplati</RadzenButton>
				}
				else
				{
					<span>Tvoje članstvo je isteklo! Datum zadnje uplate: @lastPayment!.Date.ToString("dd.MM.yyyy."), što je duže od godinu dana. </span>
					<RadzenButton Click=@OpenPaymentDialog>Uplati</RadzenButton>
				}
			</RadzenAlert>
		} else
		{
			<RadzenAlert AlertStyle="AlertStyle.Success" AllowClose=@(user.ValidMembership)>
				<span>Tvoje članstvo je aktivno! Datum zadnje uplate: @lastPayment!.Date.ToString("dd.MM.yyyy.") </span>
				@if (canPay)
				{
					<RadzenButton Click=@OpenPaymentDialog>Uplati</RadzenButton>
				}
			</RadzenAlert>
		}
		<RadzenCard Class="rz-background-color-info-lighter" Style="width: 100%;">
			<RadzenStack Style="overflow-x: auto;">
				<RadzenText TextStyle="TextStyle.H6">@(user.Name + " " + user.Surname)</RadzenText>
				<RadzenText><span style="font-weight: bold;">Primarna email adresa:</span> <code style="color: black">@user.Email</code></RadzenText>
				<RadzenText><span style="font-weight: bold;">Član/ica od:</span> @user.MembershipApprovalDate.ToString("dd.MM.yyyy. u HH:mm:ss")</RadzenText>
				<RadzenText>
					<span style="font-weight: bold;">Status članstva: </span>
					@if (user.ValidMembership)
					{
						<span style="color: green;">Aktivan</span>
					}
					else
					{
						<span style="color: red;">Neaktivan</span>
					}
				</RadzenText>
				@if (hasPayments)
				{
					<RadzenText><span style="font-weight: bold;">Zadnja uplata članarine:</span> @lastPayment!.Date.ToString("dd.MM.yyyy.")</RadzenText>
				}
				@if (user.ValidMembership)
				{
					<RadzenText>
						<span style="font-weight: bold;">Članarina vrijedi do:</span> @lastPayment!.DateUntil.ToString("dd.MM.yyyy.")
						<span> (broj dana: @((lastPayment!.DateUntil - DateTime.Now.Date).Days))</span>
					</RadzenText>
				}
				<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
					@if (canPay)
					{
						if (user.ValidMembership)
						{
							<RadzenText>Pošto je članarina uplaćena prošle godine, iako i dalje vrijedi, možete uplatiti članstvo za ovu godinu. Uplata vrijedi godinu dana:</RadzenText>
						}
						else
						{
							<RadzenText>Morate uplatiti članarinu:</RadzenText>
						}
						<RadzenButton Style="width: 200px;" Text="Uplati članarinu" Click=@OpenPaymentDialog />
					}
				</RadzenStack>
			</RadzenStack>
		</RadzenCard>
		<RadzenTemplateForm TItem="List<UserDataViewModel>" Data=@UserData Submit=@OnSubmit InvalidSubmit=@OnInvalidSubmit Style="width: 100%;">
			<RadzenStack>
				<RadzenFieldset Text="Ostali kontakti" Style="width: 100%;">
					<RadzenStack>
						<RadzenText>Ovo su vaši ostali kontakti. Oni nisu nužni, no dobro dođu u slučaju da Vas želimo kontaktirati.</RadzenText>
						<RadzenRow>
							<RadzenButton Click=@AddContact ButtonStyle="ButtonStyle.Primary" Icon="add_circle" Text="Dodaj novi kontakt" Disabled=@updatingContacts />
							<RadzenButton Click=@RemoveAllContacts ButtonStyle="ButtonStyle.Danger" Icon="warning_amber" Text="Ukloni sve kontakte" Disabled=@updatingContacts />
						</RadzenRow>
						<RadzenStack>
							@foreach (var contact in UserData)
							{
								<RadzenCard Variant="Variant.Filled">
									<RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
										<RadzenRow AlignItems="AlignItems.Center">
											<RadzenDropDown @bind-Value=contact.Name Data=@possibleContacts />
											<RadzenTextBox @bind-Value=contact.Value AllowClear="false" MaxLength="80" Placeholder=@contact.Name Name=@contact.Id.ToString() />
											<RadzenRequiredValidator Component=@contact.Id.ToString() Text="Ne može ostati prazno!" />
										</RadzenRow>
										<RadzenButton ButtonStyle="ButtonStyle.Danger" Text="🗙" JustifyContent="JustifyContent.End" Click=@(() => RemoveOneContact(contact.Id)) Disabled=@updatingContacts />
									</RadzenRow>
								</RadzenCard>
							}
						</RadzenStack>
					</RadzenStack>
				</RadzenFieldset>
				<RadzenButton ButtonStyle="ButtonStyle.Success" Text="Ažuriraj kontakte" class="align-self-md-center" ButtonType="ButtonType.Submit" Disabled=@updatingContacts />
			</RadzenStack>
		</RadzenTemplateForm>
	}
</RadzenRow>

@code {
	[CascadingParameter]
	private Task<AuthenticationState> authenticationState { get; set; }

	public User? user { get; set; } = null;
	public List<UserDataViewModel> UserData = new List<UserDataViewModel>();
	public Payment? lastPayment { get; set; } = null;

	public bool loading = true;
	public bool updatingContacts = false;

	public bool hasPayments = false;
	public bool canPay = true;

	public List<string> possibleContacts = new List<string>
	{
		"Sekundarni email",
		"Mobilni telefon",
		"Fiksni telefon",
		"Adresa",
		"Web mjesto",
		"Društvena mreža"
	};

	public int contactId = 0;

	protected override async Task OnInitializedAsync()
	{
		var state = await authenticationState;
		if (state == null)
		{
			NavigationManager.NavigateTo("/");
			return;
		}

		int userId;
		bool parsed = int.TryParse(state.User.FindFirstValue(ClaimTypes.NameIdentifier), out userId);
		if (!parsed)
		{
			NavigationManager.NavigateTo("/");
			return;
		}

		user = await UserService.GetUserById(userId);
		if (user == null)
		{
			NavigationManager.NavigateTo("/");
			return;
		}

		CheckPaymentInfo();

		UserData = user.UserData.Select(ud =>
			new UserDataViewModel(
				contactId++,
				ud.Name,
				ud.Value
			)
		).ToList();

		loading = false;
	}

	private void RemoveOneContact(int id)
	{
		UserData.RemoveAll(ud => ud.Id == id);
	}

	private void RemoveAllContacts()
	{
		contactId = 0;
		UserData = new List<UserDataViewModel>();
	}

	private void AddContact()
	{
		string whichContact = "";
		try
		{
			whichContact = possibleContacts.Where(c => !UserData.Select(ud => ud.Name).Contains(c)).First();
		} catch (Exception e)
		{
			Notifications.ShowErrorNotification("Već imaš sve kontakte!");
			return;
		}
		UserData.Add(new UserDataViewModel(contactId++, whichContact));
	}

	private void CheckPaymentInfo()
	{
		var payments = user!.Payments.ToList();

		if (payments.Count == 0)
		{
			canPay = true;
			return;
		}

		hasPayments = true;
		lastPayment = payments.OrderByDescending(p => p.Date).First();

		canPay = !(lastPayment.Year == DateTime.Now.Year);
	}

	private void OnInvalidSubmit()
	{
		Notifications.ShowErrorNotification("Kontakti nisu ispravno uneseni.");
	}

	private async Task OnSubmit()
	{
		updatingContacts = true;
		user.UserData = UserData.Select(ud => new UserData
		{
			Name = ud.Name,
			Value = ud.Value
		}).ToList();
		ServiceResponse response = await UserService.Update(user);
		if (!response.Flag)
		{
			Notifications.ShowErrorNotification(response.Message);
		} else
		{
			Notifications.ShowSuccessNotification("Kontakti su uspješno ažurirani.");
		}
		updatingContacts = false;
	}

	private async Task OpenPaymentDialog()
	{
		var result = await DialogService.OpenAsync("Potvrda o uplati", ds =>
			@<RadzenStack>
				<RadzenText>Prenesi potvrdu o uplati (PDF, maksimalna veličina datoteke: 1MB):</RadzenText>
				<RadzenButton Text="Prenesi" Click=@CreateNewPayment />
			</RadzenStack>
		);
	}

	private async Task CreateNewPayment()
	{
		
	}
}
